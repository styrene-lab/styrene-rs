name: CI

on:
  pull_request:
  push:
    branches: [main, master]

env:
  CARGO_TERM_COLOR: always

jobs:
  lint-format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Format
        run: cargo xtask ci --stage lint-format

  build-matrix:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        toolchain: [stable, 1.75.0]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.toolchain }}
      - name: Build
        run: cargo xtask ci --stage build-matrix

  test-nextest-unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest
      - name: Unit tests (nextest)
        run: cargo xtask ci --stage test-nextest-unit

  test-integration:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Integration tests
        run: cargo xtask ci --stage test-integration

  doc:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Docs
        run: cargo xtask ci --stage doc

  sdk-docs-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK docs completeness
        run: cargo xtask ci --stage sdk-docs-check

  sdk-cookbook-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK cookbook fixtures
        run: cargo xtask ci --stage sdk-cookbook-check

  sdk-ergonomics-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK ergonomics tests and examples
        run: cargo xtask ci --stage sdk-ergonomics-check

  lxmf-cli-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: LXMF CLI smoke and tests
        run: cargo xtask ci --stage lxmf-cli-check

  dx-bootstrap-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Developer bootstrap prerequisites
        run: cargo xtask ci --stage dx-bootstrap-check

  sdk-incident-runbook-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Incident runbook completeness
        run: cargo xtask ci --stage sdk-incident-runbook-check

  sdk-drill-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Backup/restore drill gate
        run: cargo xtask ci --stage sdk-drill-check

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-deny,cargo-audit
      - name: Security checks
        run: cargo xtask ci --stage security

  supply-chain-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SBOM + provenance metadata
        run: cargo xtask ci --stage supply-chain-check
      - uses: actions/upload-artifact@v4
        with:
          name: supply-chain-artifacts
          path: |
            target/supply-chain/sbom/cargo-metadata.sbom.json
            target/supply-chain/provenance/artifact-provenance.json
            target/supply-chain/provenance/artifact-provenance.sha256

  reproducible-build-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Reproducible build verification
        run: cargo xtask ci --stage reproducible-build-check
      - uses: actions/upload-artifact@v4
        with:
          name: reproducible-build-report
          path: target/supply-chain/reproducible/reproducible-build-report.txt

  unused-deps:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install nightly toolchain (for cargo-udeps)
        run: rustup toolchain install nightly --profile minimal
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-udeps
      - name: Unused dependencies
        run: cargo xtask ci --stage unused-deps

  api-surface-check:
    runs-on: ubuntu-latest
    env:
      SDK_API_BREAK_TOOLCHAIN: nightly-2026-02-15
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install pinned nightly toolchain (for cargo-public-api)
        run: rustup toolchain install nightly-2026-02-15 --profile minimal
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-public-api@0.50.2
      - name: API surface
        run: cargo xtask ci --stage api-surface-check

  sdk-schema-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK schema fixtures
        run: cargo xtask ci --stage sdk-schema-check

  interop-artifacts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Interop artifacts manifest
        run: cargo xtask ci --stage interop-artifacts

  e2e-compatibility:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: E2E compatibility workflows
        run: cargo xtask ci --stage e2e-compatibility

  sdk-conformance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK conformance suite
        run: cargo xtask ci --stage sdk-conformance

  sdk-security-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK security suite
        run: cargo xtask ci --stage sdk-security-check

  sdk-fuzz-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK parser fuzz smoke suite
        run: cargo xtask ci --stage sdk-fuzz-check

  sdk-property-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK property suite
        run: cargo xtask ci --stage sdk-property-check

  sdk-model-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK model conformance suite
        run: cargo xtask ci --stage sdk-model-check

  sdk-race-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK race stress suite
        run: cargo xtask ci --stage sdk-race-check

  sdk-replay-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK replay determinism suite
        run: cargo xtask ci --stage sdk-replay-check

  sdk-metrics-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK metrics contract and endpoint suite
        run: cargo xtask ci --stage sdk-metrics-check

  sdk-bench-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK benchmark baseline
        run: cargo xtask ci --stage sdk-bench-check
      - uses: actions/upload-artifact@v4
        with:
          name: sdk-bench-report
          path: |
            target/criterion/bench-summary.txt
            target/criterion/**/estimates.json

  sdk-perf-budget-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK performance budget gate
        run: cargo xtask ci --stage sdk-perf-budget-check
      - uses: actions/upload-artifact@v4
        with:
          name: sdk-perf-budget-report
          path: |
            target/criterion/bench-budget-report.txt
            target/criterion/bench-summary.txt

  sdk-memory-budget-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK memory budget gate
        run: cargo xtask ci --stage sdk-memory-budget-check

  sdk-queue-pressure-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK queue pressure gate
        run: cargo xtask ci --stage sdk-queue-pressure-check

  sdk-matrix-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK feature matrix gate
        run: cargo xtask ci --stage sdk-matrix-check

  sdk-profile-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK profile build matrix
        run: cargo xtask ci --stage sdk-profile-build

  sdk-examples-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK example compile gate
        run: cargo xtask ci --stage sdk-examples-check

  sdk-api-break:
    runs-on: ubuntu-latest
    env:
      SDK_API_BREAK_TOOLCHAIN: nightly-2026-02-15
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install pinned nightly toolchain (for cargo-public-api)
        run: rustup toolchain install nightly-2026-02-15 --profile minimal
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-public-api@0.50.2
      - name: SDK API break gate
        run: cargo xtask ci --stage sdk-api-break

  sdk-migration-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK migration gate
        run: cargo xtask ci --stage sdk-migration-check

  forbidden-deps:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Architecture boundaries
        run: cargo xtask ci --stage forbidden-deps

  architecture-checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Architecture boundaries
        run: cargo xtask ci --stage architecture-checks

  migration-checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Migration checks
        run: cargo xtask ci --stage migration-checks
