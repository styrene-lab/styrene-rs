name: CI

on:
  pull_request:
  push:
    branches: [main, master]

env:
  CARGO_TERM_COLOR: always

jobs:
  lint-format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Format
        run: cargo xtask ci --stage lint-format

  build-matrix:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        toolchain: [stable, 1.75.0]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.toolchain }}
      - name: Build
        run: cargo xtask ci --stage build-matrix

  test-nextest-unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest
      - name: Unit tests (nextest)
        run: cargo xtask ci --stage test-nextest-unit

  test-integration:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Integration tests
        run: cargo xtask ci --stage test-integration

  doc:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Docs
        run: cargo xtask ci --stage doc

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-deny,cargo-audit
      - name: Security checks
        run: cargo xtask ci --stage security

  unused-deps:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install nightly toolchain (for cargo-udeps)
        run: rustup toolchain install nightly --profile minimal
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-udeps
      - name: Unused dependencies
        run: cargo xtask ci --stage unused-deps

  api-surface-check:
    runs-on: ubuntu-latest
    env:
      SDK_API_BREAK_TOOLCHAIN: nightly-2026-02-15
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install pinned nightly toolchain (for cargo-public-api)
        run: rustup toolchain install nightly-2026-02-15 --profile minimal
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-public-api@0.50.2
      - name: API surface
        run: cargo xtask ci --stage api-surface-check

  sdk-schema-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK schema fixtures
        run: cargo xtask ci --stage sdk-schema-check

  interop-artifacts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Interop artifacts manifest
        run: cargo xtask ci --stage interop-artifacts

  e2e-compatibility:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: E2E compatibility workflows
        run: cargo xtask ci --stage e2e-compatibility

  sdk-conformance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK conformance suite
        run: cargo xtask ci --stage sdk-conformance

  sdk-security-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK security suite
        run: cargo xtask ci --stage sdk-security-check

  sdk-property-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK property suite
        run: cargo xtask ci --stage sdk-property-check

  sdk-model-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK model conformance suite
        run: cargo xtask ci --stage sdk-model-check

  sdk-race-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK race stress suite
        run: cargo xtask ci --stage sdk-race-check

  sdk-matrix-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK feature matrix gate
        run: cargo xtask ci --stage sdk-matrix-check

  sdk-profile-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK profile build matrix
        run: cargo xtask ci --stage sdk-profile-build

  sdk-examples-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK example compile gate
        run: cargo xtask ci --stage sdk-examples-check

  sdk-api-break:
    runs-on: ubuntu-latest
    env:
      SDK_API_BREAK_TOOLCHAIN: nightly-2026-02-15
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install pinned nightly toolchain (for cargo-public-api)
        run: rustup toolchain install nightly-2026-02-15 --profile minimal
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-public-api@0.50.2
      - name: SDK API break gate
        run: cargo xtask ci --stage sdk-api-break

  sdk-migration-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK migration gate
        run: cargo xtask ci --stage sdk-migration-check

  forbidden-deps:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Architecture boundaries
        run: cargo xtask ci --stage forbidden-deps

  architecture-checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Architecture boundaries
        run: cargo xtask ci --stage architecture-checks

  migration-checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Migration checks
        run: cargo xtask ci --stage migration-checks
