name: CI

on:
  pull_request:
  push:
    branches: [main, master]

env:
  CARGO_TERM_COLOR: always

jobs:
  lint-format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Format
        run: cargo fmt --all -- --check

  build-matrix:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        toolchain: [stable, 1.75.0]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.toolchain }}
      - name: Build
        run: cargo build --workspace --all-targets

  test-nextest-unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest
      - name: Unit tests (nextest)
        run: cargo nextest run --workspace --lib --bins

  test-integration:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Integration tests
        run: cargo test --workspace --tests

  doc:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Docs
        run: cargo doc --workspace --no-deps

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-deny,cargo-audit
      - name: Dependency policy
        run: cargo deny check
      - name: Security audit
        run: cargo audit

  unused-deps:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install nightly toolchain (for cargo-udeps)
        run: rustup toolchain install nightly --profile minimal
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-udeps
      - name: Unused dependencies
        run: cargo +nightly udeps --workspace --all-targets

  api-surface-check:
    runs-on: ubuntu-latest
    env:
      SDK_API_BREAK_TOOLCHAIN: nightly-2026-02-15
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install pinned nightly toolchain (for cargo-public-api)
        run: rustup toolchain install nightly-2026-02-15 --profile minimal
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-public-api@0.50.2
      - name: API surface
        run: cargo xtask api-diff

  sdk-schema-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK schema fixtures
        run: cargo xtask sdk-schema-check

  sdk-conformance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK conformance suite
        run: cargo xtask sdk-conformance

  sdk-profile-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK profile build matrix
        run: cargo xtask sdk-profile-build

  sdk-api-break:
    runs-on: ubuntu-latest
    env:
      SDK_API_BREAK_TOOLCHAIN: nightly-2026-02-15
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install pinned nightly toolchain (for cargo-public-api)
        run: rustup toolchain install nightly-2026-02-15 --profile minimal
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-public-api@0.50.2
      - name: SDK API break gate
        run: cargo xtask sdk-api-break

  sdk-migration-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: SDK migration gate
        run: cargo xtask sdk-migration-check

  forbidden-deps:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Architecture boundaries
        run: cargo xtask forbidden-deps

  architecture-checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Architecture boundaries
        run: cargo xtask architecture-checks

  migration-checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Migration checks
        run: cargo xtask migration-checks
