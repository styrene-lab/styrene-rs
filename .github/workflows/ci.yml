name: CI

on:
  pull_request:
  push:
    branches: [main, master]

env:
  CARGO_TERM_COLOR: always

jobs:
  lint-format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Format
        run: cargo fmt --all -- --check

  build-matrix:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        toolchain: [stable, 1.75.0]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.toolchain }}
      - name: Build
        run: cargo build --workspace --all-targets

  test-nextest-unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest
      - name: Unit tests (nextest)
        run: cargo nextest run --workspace --lib --bins

  test-integration:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Integration tests
        run: cargo test --workspace --tests

  doc:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Docs
        run: cargo doc --workspace --no-deps

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-deny,cargo-audit
      - name: Dependency policy
        run: cargo deny check
      - name: Security audit
        run: cargo audit

  unused-deps:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install nightly toolchain (for cargo-udeps)
        run: rustup toolchain install nightly --profile minimal
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-udeps
      - name: Unused dependencies
        run: cargo +nightly udeps --workspace --all-targets

  api-surface-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install nightly toolchain (for cargo-public-api)
        run: rustup toolchain install nightly --profile minimal
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-public-api
      - name: API surface
        run: |
          for manifest in \
            crates/libs/lxmf-core/Cargo.toml \
            crates/libs/lxmf-runtime/Cargo.toml \
            crates/libs/rns-core/Cargo.toml \
            crates/libs/rns-transport/Cargo.toml \
            crates/libs/rns-rpc/Cargo.toml; do
            RUSTUP_TOOLCHAIN=nightly \
            RUSTC="$(rustup which --toolchain nightly rustc)" \
            RUSTDOC="$(rustup which --toolchain nightly rustdoc)" \
            cargo public-api --manifest-path "$manifest"
          done
      - name: Architecture boundaries
        run: ./tools/scripts/check-boundaries.sh
